name: Update Rust toolchain

on:
  # schedule:
  #   - cron: '0 * * * *'  # Debug
  pull_request:
    branches: [ main ]

jobs:
  update-rust-toolchains:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.LIBAFL_UPDATER }}

      - name: Edit
        run: |
          sed -i 's/rustup toolchain install nightly[0-9a-zA-Z\-]*/\`date +"rustup toolchain install nightly-%Y-%m-%d"\`/' ./.github/workflows/build_and_test.yml

      - uses: EndBug/add-and-commit@v9 # You can change this to use a specific version.
        with:
          add: '.'
          author_name: Github Actions
          author_email: mail@example.com
          message: 'Update rust deps'
          # If this input is set, the action will push the commit to a new branch with this name.
          # Default: ''
          new_branch: update_from_ci

          # Whether to push the commit and, if any, its tags to the repo. It can also be used to set the git push arguments (see the paragraph below for more info)
          # Default: true
          push: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.LIBAFL_UPDATER }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          commit-message: Add report file
          title: '[Example] Add report file'
          base: main
          branch: update_from_ci
          assignees: tokatoka
          body: >
            This PR is auto-generated by 
            [create-pull-request](https://github.com/peter-evans/create-pull-request).

# Default recipe, runs when you just type `just`
default: build

# Build both projects
build: build-runtime build-fuzzer

# Test both projects
test: test-runtime test-fuzzer test-concolic

# Clean both projects
clean: clean-runtime clean-fuzzer

# --- Runtime Project ---

# Build the runtime project
build-runtime:
    @echo "Building the runtime project..."
    @cargo build --manifest-path runtime/Cargo.toml

# Test the runtime project (depends on it being built first)
test-runtime: build-runtime
    @echo "Running runtime tests..."
    @cargo test --manifest-path runtime/Cargo.toml

# Clean the runtime project
clean-runtime:
    @echo "Cleaning runtime project..."
    @cargo clean --manifest-path runtime/Cargo.toml


# --- Fuzzer Project ---

# Build the fuzzer project
build-fuzzer:
    @echo "Building the fuzzer project..."
    @cargo build --manifest-path fuzzer/Cargo.toml

# Test the fuzzer project (depends on it being built first)
test-fuzzer: build-fuzzer
    @echo "Running fuzzer tests..."
    @cargo test --manifest-path fuzzer/Cargo.toml

# Clean the fuzzer project
clean-fuzzer:
    @echo "Cleaning fuzzer project..."
    @cargo clean --manifest-path fuzzer/Cargo.toml

# Test the concolic fuzzer
test-concolic: build-fuzzer
    @echo "Running concolic fuzzer reproduction..."
    rm -f concolic_test.log
    @# Setup environment: copy target_symcc.out, create corpus with seeds
    cp fuzzer/target_symcc.out .
    mkdir -p corpus
    cp ../../../seeds/pngs/not_kitty.png corpus/
    @# Run with a timeout and tee output to a log file.
    @# Ensure LD_LIBRARY_PATH includes runtime for libSymRuntime.so
    export LD_LIBRARY_PATH=$(pwd)/runtime:$LD_LIBRARY_PATH
    @# Build with default features (restarting enabled)
    @cargo build --manifest-path fuzzer/Cargo.toml --features std
    @# 30 seconds should be enough to find something
    timeout -s SIGINT 30s ./fuzzer/target/debug/libfuzzer_stb_image_concolic --concolic > concolic_test.log 2>&1 || true
    @# Check if we found any new paths (corpus > 1)
    @if grep -E "corpus: +([2-9]|[1-9][0-9]+)" concolic_test.log; then \
        echo "Concolic fuzzer found new paths (success)!"; \
        rm -rf concolic_test.log target_symcc.out corpus; \
    else \
        echo "No new paths found by concolic fuzzer!"; \
        grep "corpus:" concolic_test.log | tail -n 1; \
        exit 1; \
    fi
    rm -f concolic_test.log target_symcc.out
    rm -rf corpus


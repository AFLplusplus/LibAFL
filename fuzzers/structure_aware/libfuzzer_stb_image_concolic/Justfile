# Default recipe, runs when you just type `just`
default: build

# Build both projects
build: build-runtime build-fuzzer

# Test both projects
test: test-runtime test-fuzzer test-concolic

# Clean both projects
clean: clean-runtime clean-fuzzer

# --- Runtime Project ---

# Build the runtime project
build-runtime:
    @echo "Building the runtime project..."
    @cargo build --manifest-path runtime/Cargo.toml

# Test the runtime project (depends on it being built first)
test-runtime: build-runtime
    @echo "Running runtime tests..."
    @cargo test --manifest-path runtime/Cargo.toml

# Clean the runtime project
clean-runtime:
    @echo "Cleaning runtime project..."
    @cargo clean --manifest-path runtime/Cargo.toml


# --- Fuzzer Project ---

# Build the fuzzer project
build-fuzzer:
    @echo "Building the fuzzer project..."
    @cargo build --manifest-path fuzzer/Cargo.toml

# Test the fuzzer project (depends on it being built first)
test-fuzzer: build-fuzzer
    @echo "Running fuzzer tests..."
    @cargo test --manifest-path fuzzer/Cargo.toml

# Clean the fuzzer project
clean-fuzzer:
    @echo "Cleaning fuzzer project..."
    @cargo clean --manifest-path fuzzer/Cargo.toml

# Test the concolic fuzzer
test-concolic: build-fuzzer
    @echo "Running concolic fuzzer reproduction..."
    rm -f concolic_test.log
    @# Run with a timeout and tee output to a log file.
    @timeout -s SIGINT 15s ./fuzzer/target/debug/libfuzzer_stb_image_concolic --concolic > concolic_test.log 2>&1 || [ $? -eq 124 ]
    @# Check if any objectives (crashes) were found in the log.
    @if grep -q '"objectives": [1-9]' concolic_test.log; then \
        echo "Success: Concolic fuzzer found crashes."; \
        rm -f concolic_test.log; \
    else \
        echo "Error: No crashes found by concolic fuzzer!"; \
        cat concolic_test.log; \
        exit 1; \
    fi

